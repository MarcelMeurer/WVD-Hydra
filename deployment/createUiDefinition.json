{
   "$schema":"https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
   "handler":"Microsoft.Azure.CreateUIDef",
   "version":"0.1.2-preview",
   "parameters":{
      "resourceTypes":[
         "Microsoft.OperationalInsights/workspaces",
         "Microsoft.Sql/servers",
         "Microsoft.KeyVault/vaults",
         "Microsoft.Web/serverfarms",
		 "Microsoft.Storage/storageAccounts",
		 "Microsoft.Web/sites"
      ],
      "basics":[
             {
    "name": "nameApiWeb",
    "type": "Microsoft.Solutions.ArmApiControl",
    "request": {
      "method": "POST",
      "path": "[concat(subscription().id,'/providers/Microsoft.Web/checkNameAvailability?api-version=2019-08-01')]",
      "body": "[parse(concat('{\"name\":\"',basics('siteName'),'\",\"type\":\"Microsoft.Web/sites\"}',''))]"
    }
},
{
    "name": "nameApiSql",
    "type": "Microsoft.Solutions.ArmApiControl",
    "request": {
      "method": "POST",
      "path": "[concat(subscription().id,'/providers/Microsoft.Sql/checkNameAvailability?api-version=2014-04-01')]",
      "body": "[parse(concat('{\"name\":\"',basics('siteName'),'\",\"type\":\"Microsoft.Sql/servers\"}',''))]"
    }
},
{
    "name": "nameApiKeyVault",
    "type": "Microsoft.Solutions.ArmApiControl",
    "request": {
      "method": "POST",
      "path": "[concat(subscription().id,'/providers/Microsoft.KeyVault/checkNameAvailability?api-version=2019-09-01')]",
      "body": "[parse(concat('{\"name\":\"',basics('siteName'),'\",\"type\":\"Microsoft.KeyVault/vaults\"}',''))]"
    }
},
         {
            "name":"siteName",
            "type":"Microsoft.Common.TextBox",
            "label":"Name of your deployment",
            "toolTip":"The name should include 4-22 letters, digits or '-'. The '-' shouldn't be the first symbol.",
            "constraints":{
               "required":true,
               "regex":"^[a-z0-9A-Z]{1}[a-z0-9A-Z-]{3,21}$",
               "validationMessage":"The name should include 4-22 letters, digits or '-'. The '-' shouldn't be the first symbol.",
      "validations": [
        {
          "isValid": "[or(less(length(basics('siteName')),4),not(equals(basics('nameApiWeb').nameAvailable, false)))]",
          "message": "Please use another name. The name is not available for a web site"
        },
        {
          "isValid": "[or(less(length(basics('siteName')),4),not(equals(basics('nameApiSql').available, false)))]",
          "message": "Please use another name. The name is not available for a SQL instance"
        },
        {
          "isValid": "[or(less(length(basics('siteName')),4),not(equals(basics('nameApiKeyVault').nameAvailable, false)))]",
          "message": "Please use another name. The name is not available for a key vault"
        }

      ]
            }
         }
      ],
      "steps":[
         {
            "name":"ServicePrincipal",
            "label":"Service Principal",
            "elements":[
               {
                  "name":"textSp",
                  "type":"Microsoft.Common.TextBlock",
                  "visible":true,
                  "options":{
                     "text":"[concat('A service principal is needed to authenticate to the web app. Please create a service principal based on the documentation and enter the application id and secret. Optionally: Id and secret can be changed on the deployed Key Vault after the deployment. The redirect URI is \"https://',basics('siteName'),'.azurewebsites.net/signin-oidc\"')]",
                     "link":{
                        "label":"Learn more",
                        "uri":"[concat('https://github.com/MarcelMeurer/WVD-Hydra/WebApp-ServicePrinciaplCode?redirectUri=https://',basics('siteName'),'.azurewebsites.net/signin-oidc')]"
                     }
                  }
               },
               {
                  "name":"spId",
                  "type":"Microsoft.Common.TextBox",
                  "label":"Application Id",
                  "toolTip":"The application id of the service principal must be in the format '00000000-0000-0000-0000-000000000000'",
                  "constraints":{
                     "required":true,
                     "regex":"^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$",
                     "validationMessage":"The application id of the service principal must be in the format '00000000-0000-0000-0000-000000000000'"
                  }
               },
               {
                  "name":"spSecret",
                  "type":"Microsoft.Common.PasswordBox",

				                  "label": {
                    "password": "The secret of the service principal",
                    "confirmPassword": "Confirm secret"
                },
				                "options": {
                    "hideConfirmation": false
                },
                  "toolTip":"A secret string with a least one character",
                  "constraints":{
                     "required":true,
                     "validationMessage":"A secret string with a least one character"
                  }
               }
            ]
         },
         {
            "name":"Administration",
            "label":"Administration",
            "elements":[
               {
                  "name":"textAdmin",
                  "type":"Microsoft.Common.TextBlock",
                  "visible":true,
                  "options":{
                     "text":"Enter the UPN of the administrator, who should have unlimited permission in the solution - the user must exist or be invited in this tenant. This UPN can log on after the deployment and configuration. This setting can be changed in the configuration of the deployed web app. It's possible to add more users or groups (object ids of the groups) comma-delimited. E.g: 'admin@contoso.com'",
                     "link":{
                        "label":"Learn more",
                        "uri":"https://github.com/MarcelMeurer/WVD-Hydra"
                     }
                  }
               },
               {
                  "name":"admins",
                  "type":"Microsoft.Common.TextBox",
                  "label":"Administrator(s) of the solution",
                  "toolTip":"Comma-delimited list of full admins of the solutions (at least one UPN)",
                  "constraints":{
                     "required":true,
                     "regex":"^([\\w+-.%]+@[\\w-.]+\\.[A-Za-z]{2,4},?)+$",
                     "validationMessage":"At least one UPN mus be entered (admin@contoso.com)"
                  }
               }
            ]
         },
         {
            "name":"tags",
            "label":"Tags",
			"elements":[
               {
                  "name":"tagsByResource",
                  "type":"Microsoft.Common.TagsByResource",
				  "toolTip":"Add tags to the resources for governance reason",
                  "resources":[
                     "Microsoft.OperationalInsights/workspaces",
					 "Microsoft.Sql/servers",
                     "Microsoft.KeyVault/vaults",
                     "Microsoft.Web/serverfarms",
					 "Microsoft.Storage/storageAccounts",
					 "Microsoft.Web/sites"
                  ]
               }
            ]
         }
      ],
      "outputs":{
         "spId":"[steps('ServicePrincipal').spId]",
         "spSecret":"[steps('ServicePrincipal').spSecret]",
         "location":"[location()]",
         "siteName":"[basics('siteName')]",
         "admins":"[steps('Administration').admins]",
         "tagsByResource":"[steps('tags').tagsByResource]"
      }
   }
}